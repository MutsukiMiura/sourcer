!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var Field_1=require("../core/Field"),ExposedScriptLoader_1=require("../core/ExposedScriptLoader"),issueId=0,callbacks={};onmessage=function(_a){var data=_a.data;if(void 0!==data.issuedId)return callbacks[data.issuedId](),void delete callbacks[data.issuedId];var initialParameter=data,isDemo=initialParameter.isDemo,players=initialParameter.sources,frames=[],listener={waitNextTick:function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(_a){return[2,new Promise(function(resolve){var issuedId=issueId++;callbacks[issuedId]=resolve,postMessage({issuedId:issuedId,command:"Next"})})]})})},onPreThink:function(sourcerId){postMessage({command:"PreThink",id:sourcerId})},onPostThink:function(sourcerId){postMessage({command:"PostThink",id:sourcerId,loadedFrame:frames.length})},onFrame:function(fieldDump){frames.push(fieldDump)},onFinished:function(result){postMessage({result:result,command:"Finished"})},onEndOfGame:function(){postMessage({frames:frames,command:"EndOfGame"})},onError:function(error){postMessage({error:error,command:"Error"})}},field=new Field_1.default(ExposedScriptLoader_1.default,isDemo);players.forEach(function(value,index){field.registerSourcer(value.source,value.name,value.name,value.color)}),postMessage({command:"Players",players:field.players()}),setTimeout(function(){return __awaiter(_this,void 0,void 0,function(){var count;return __generator(this,function(_a){switch(_a.label){case 0:return[4,field.compile(listener)];case 1:_a.sent(),count=0,_a.label=2;case 2:return count<1e4&&!field.isFinished?[4,field.tick(listener)]:[3,5];case 3:_a.sent(),_a.label=4;case 4:return count++,[3,2];case 5:return[2]}})})},0)}},{"../core/ExposedScriptLoader":7,"../core/Field":8}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var V_1=require("./V"),Configs_1=require("./Configs"),Actor=function(){function Actor(field,x,y){this.field=field,this.size=Configs_1.default.COLLISION_SIZE,this.wait=0,this.wait=0,this.position=new V_1.default(x,y),this.speed=new V_1.default(0,0)}return Actor.prototype.think=function(){this.wait<=0?(this.wait=0,this.onThink()):this.wait=this.wait-1},Actor.prototype.onThink=function(){},Actor.prototype.action=function(){},Actor.prototype.move=function(){this.position=this.position.add(this.speed)},Actor.prototype.onHit=function(shot){},Actor.prototype.dump=function(){throw new Error("not implimentation")},Actor}();exports.default=Actor},{"./Configs":4,"./V":20}],3:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Command=function(){function Command(){this.isAccepted=!1}return Command.prototype.validate=function(){if(!this.isAccepted)throw new Error("Invalid command.")},Command.prototype.accept=function(){this.isAccepted=!0},Command.prototype.unaccept=function(){this.isAccepted=!1},Command}();exports.default=Command},{}],4:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Configs=function(){function Configs(){}return Configs.INITIAL_SHIELD=100,Configs.INITIAL_FUEL=100,Configs.INITIAL_MISSILE_AMMO=20,Configs.LASER_ATTENUATION=1,Configs.LASER_MOMENTUM=128,Configs.FUEL_COST=.24,Configs.COLLISION_SIZE=4,Configs.SCAN_WAIT=.35,Configs.SPEED_RESISTANCE=.96,Configs.GRAVITY=.1,Configs.TOP_INVISIBLE_HAND=480,Configs.DISTANCE_BORDAR=400,Configs.DISTANCE_INVISIBLE_HAND=.008,Configs.OVERHEAT_BORDER=100,Configs.OVERHEAT_DAMAGE_LINEAR_WEIGHT=.05,Configs.OVERHEAT_DAMAGE_POWER_WEIGHT=.012,Configs.GROUND_DAMAGE_SCALE=1,Configs.COOL_DOWN=.5,Configs.ON_HIT_SPEED_GIVEN_RATE=.4,Configs}();exports.default=Configs},{}],5:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Consts=function(){function Consts(){}return Consts.DIRECTION_RIGHT=1,Consts.DIRECTION_LEFT=-1,Consts.VERTICAL_UP="vertial_up",Consts.VERTICAL_DOWN="vertial_down",Consts}();exports.default=Consts},{}],6:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Controller=function(actor){var _this=this;this.framesOfLife=0,this.preThink=function(){_this.framesOfLife++},this.frame=function(){return _this.framesOfLife},this.altitude=function(){return actor.position.y},this.wait=function(frame){0<frame&&(actor.wait+=frame)}};exports.default=Controller},{}],7:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ExposedScriptLoader=function(){function ExposedScriptLoader(){this.console={log:function(){for(var message=[],_i=0;_i<arguments.length;_i++)message[_i]=arguments[_i]}};var allowLibs={Object:Object,String:String,Number:Number,Boolean:Boolean,Array:Array,Date:Date,Math:Math,RegExp:RegExp,JSON:JSON,NaN:NaN,Infinity:1/0,undefined:void 0,parseInt:parseInt,parseFloat:parseFloat,isNaN:isNaN,isFinite:isFinite,console:this.console};this.argNames=Object.keys(allowLibs),this.argValues=this.argNames.map(function(key){return allowLibs[key]})}return ExposedScriptLoader.prototype.isDebuggable=function(){return!0},ExposedScriptLoader.prototype.getExposedConsole=function(){return this.console},ExposedScriptLoader.prototype.load=function(script){var argNames=[];return(argNames=argNames.concat(this.argNames)).push('"use strict";\n'+script),function(constructor,args){function fun(){return constructor.apply(this,args)}return fun.prototype=constructor.prototype,new fun}(Function,argNames).apply(void 0,this.argValues)},ExposedScriptLoader}();exports.default=ExposedScriptLoader},{}],8:[function(require,module,exports){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var V_1=require("./V"),Sourcer_1=require("./Sourcer"),Utils_1=require("./Utils"),Field=function(){function Field(scriptLoaderConstructor,isDemo){void 0===isDemo&&(isDemo=!1),this.scriptLoaderConstructor=scriptLoaderConstructor,this.isDemo=isDemo,this.currentId=0,this.isFinished=!1,this.dummyEnemy=new V_1.default(0,150),this.frame=0,this.sourcers=[],this.shots=[],this.fxs=[]}return Field.prototype.registerSourcer=function(source,account,name,color){var side=this.sourcers.length%2==0?-1:1,x=Utils_1.default.rand(80)+160*side,y=Utils_1.default.rand(160)+80;this.addSourcer(new Sourcer_1.default(this,x,y,source,account,name,color))},Field.prototype.process=function(listener,think){return __awaiter(this,void 0,void 0,function(){var _i,_a,sourcer;return __generator(this,function(_b){switch(_b.label){case 0:_i=0,_a=this.sourcers,_b.label=1;case 1:return _i<_a.length?(sourcer=_a[_i],listener.onPreThink(sourcer.id),[4,listener.waitNextTick()]):[3,5];case 2:return _b.sent(),think(sourcer),listener.onPostThink(sourcer.id),[4,listener.waitNextTick()];case 3:_b.sent(),_b.label=4;case 4:return _i++,[3,1];case 5:return[2]}})})},Field.prototype.compile=function(listener){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){return[2,this.process(listener,function(sourcer){try{sourcer.compile(new _this.scriptLoaderConstructor)}catch(error){listener.onError("There is an error in your code:　"+error.message)}})]})})},Field.prototype.addSourcer=function(sourcer){sourcer.id=this.currentId++,this.sourcers.push(sourcer)},Field.prototype.addShot=function(shot){shot.id=this.currentId++,this.shots.push(shot)},Field.prototype.removeShot=function(target){var index=this.shots.indexOf(target);0<=index&&this.shots.splice(index,1)},Field.prototype.addFx=function(fx){fx.id=this.currentId++,this.fxs.push(fx)},Field.prototype.removeFx=function(target){var index=this.fxs.indexOf(target);0<=index&&this.fxs.splice(index,1)},Field.prototype.tick=function(listener){return __awaiter(this,void 0,void 0,function(){var _this=this;return __generator(this,function(_a){switch(_a.label){case 0:return 0===this.frame&&listener.onFrame(this.dump()),this.center=this.computeCenter(),[4,this.process(listener,function(sourcer){sourcer.think(),_this.shots.filter(function(shot){return shot.owner.id===sourcer.id}).forEach(function(shot){return shot.think()})})];case 1:return _a.sent(),this.sourcers.forEach(function(actor){return actor.action()}),this.shots.forEach(function(actor){return actor.action()}),this.fxs.forEach(function(actor){return actor.action()}),this.sourcers.forEach(function(actor){return actor.move()}),this.shots.forEach(function(actor){return actor.move()}),this.fxs.forEach(function(actor){return actor.move()}),this.checkFinish(listener),this.checkEndOfGame(listener),this.frame++,listener.onFrame(this.dump()),[2]}})})},Field.prototype.checkFinish=function(listener){if(this.isDemo)128<this.frame&&(this.result={frame:this.frame,timeout:null,isDraw:null,winnerId:null},listener.onFinished(this.result));else if(!this.result){this.sourcers.forEach(function(sourcer){sourcer.alive=0<sourcer.shield});var survivers=this.sourcers.filter(function(sourcer){return sourcer.alive});if(!(1<survivers.length)){if(1===survivers.length){var surviver=survivers[0];return this.result={winnerId:surviver.id,frame:this.frame,timeout:null,isDraw:!1},void listener.onFinished(this.result)}this.result={winnerId:null,timeout:null,frame:this.frame,isDraw:!0},listener.onFinished(this.result)}}},Field.prototype.checkEndOfGame=function(listener){if(!this.isFinished&&this.result)return this.isDemo?(this.isFinished=!0,void listener.onEndOfGame()):void(this.result.frame<this.frame-90&&(this.isFinished=!0,listener.onEndOfGame()))},Field.prototype.scanEnemy=function(owner,radar){return this.isDemo&&1===this.sourcers.length?radar(this.dummyEnemy):this.sourcers.some(function(sourcer){return sourcer.alive&&sourcer!==owner&&radar(sourcer.position)})},Field.prototype.scanAttack=function(owner,radar){var _this=this;return this.shots.some(function(shot){return shot.owner!==owner&&radar(shot.position)&&_this.isIncoming(owner,shot)})},Field.prototype.isIncoming=function(owner,shot){var ownerPosition=owner.position,actorPosition=shot.position,currentDistance=ownerPosition.distance(actorPosition);return ownerPosition.distance(actorPosition.add(shot.speed))<currentDistance},Field.prototype.checkCollision=function(shot){var f=shot.position,t=shot.position.add(shot.speed),collidedShot=this.shots.find(function(actor){return actor.breakable&&actor.owner!==shot.owner&&Utils_1.default.calcDistance(f,t,actor.position)<shot.size+actor.size});if(collidedShot)return collidedShot;var collidedSourcer=this.sourcers.find(function(sourcer){return sourcer.alive&&sourcer!==shot.owner&&Utils_1.default.calcDistance(f,t,sourcer.position)<shot.size+sourcer.size});return collidedSourcer||null},Field.prototype.checkCollisionEnviroment=function(shot){return shot.position.y<0},Field.prototype.computeCenter=function(){var count=0,sumX=0;return this.sourcers.forEach(function(sourcer){sourcer.alive&&(sumX+=sourcer.position.x,count++)}),sumX/count},Field.prototype.players=function(){var players={};return this.sourcers.forEach(function(sourcer){players[sourcer.id]={name:sourcer.name||sourcer.account,account:sourcer.account,color:sourcer.color}}),players},Field.prototype.dump=function(){var sourcersDump=[],shotsDump=[],fxDump=[];this.sourcers.forEach(function(actor){sourcersDump.push(actor.dump())});return this.shots.forEach(function(actor){shotsDump.push(actor.dump())}),this.fxs.forEach(function(fx){fxDump.push(fx.dump())}),{f:this.frame,s:sourcersDump,b:shotsDump,x:fxDump}},Field}();exports.default=Field},{"./Sourcer":16,"./Utils":19,"./V":20}],9:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var FireParam=function(){function FireParam(){}return FireParam.laser=function(power,direction){var result=new FireParam;return result.power=Math.min(Math.max(power||8,3),8),result.direction=direction,result.shotType="Laser",result},FireParam.missile=function(bot){var result=new FireParam;return result.bot=bot,result.shotType="Missile",result},FireParam}();exports.default=FireParam},{}],10:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Fx=function(){function Fx(field,position,speed,length){this.field=field,this.position=position,this.speed=speed,this.length=length,this.frame=0}return Fx.prototype.action=function(){this.frame++,this.length<=this.frame&&this.field.removeFx(this)},Fx.prototype.move=function(){this.position=this.position.add(this.speed)},Fx.prototype.dump=function(){return{i:this.id,p:this.position.minimize(),f:this.frame,l:Math.round(this.length)}},Fx}();exports.default=Fx},{}],11:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Shot_1=require("./Shot"),V_1=require("./V"),Configs_1=require("./Configs"),Laser=function(_super){function Laser(field,owner,direction,power){var _this=_super.call(this,field,owner,"Laser")||this;return _this.direction=direction,_this.temperature=5,_this.damage=function(){return 8},_this.speed=V_1.default.direction(direction).multiply(power),_this.momentum=Configs_1.default.LASER_MOMENTUM,_this}return __extends(Laser,_super),Laser.prototype.action=function(){_super.prototype.action.call(this),this.momentum-=Configs_1.default.LASER_ATTENUATION,this.momentum<0&&this.field.removeShot(this)},Laser}(Shot_1.default);exports.default=Laser},{"./Configs":4,"./Shot":15,"./V":20}],12:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Shot_1=require("./Shot"),Configs_1=require("./Configs"),MissileCommand_1=require("./MissileCommand"),MissileController_1=require("./MissileController"),Consts_1=require("./Consts"),Missile=function(_super){function Missile(field,owner,bot){var _this=_super.call(this,field,owner,"Missile")||this;return _this.bot=bot,_this.temperature=10,_this.damage=function(){return 10+2*_this.speed.length()},_this.fuel=100,_this.breakable=!0,_this.direction=owner.direction===Consts_1.default.DIRECTION_RIGHT?0:180,_this.speed=owner.speed,_this.command=new MissileCommand_1.default(_this),_this.command.reset(),_this.controller=new MissileController_1.default(_this),_this}return __extends(Missile,_super),Missile.prototype.onThink=function(){if(this.command.reset(),!(this.fuel<=0))try{this.command.accept(),this.controller.preThink(),this.debugDump={logs:[],arcs:[]},this.controller.connectConsole(this.owner.scriptLoader.getExposedConsole()),this.bot(this.controller)}catch(error){this.command.reset(),this.debugDump.logs.push({message:"Missile function error: "+error.message,color:"red"})}finally{this.command.unaccept()}},Missile.prototype.onAction=function(){this.speed=this.speed.multiply(Configs_1.default.SPEED_RESISTANCE),this.command.execute(),this.command.reset()},Missile.prototype.onHit=function(attack){this.field.removeShot(this),this.field.removeShot(attack)},Missile.prototype.opposite=function(direction){return this.direction+direction},Missile.prototype.log=function(message){this.debugDump.logs.push({message:message})},Missile.prototype.scanDebug=function(direction,angle,renge){this.debugDump.arcs.push({direction:direction,angle:angle,renge:renge})},Missile.prototype.dump=function(){var superDump=_super.prototype.dump.call(this);return this.owner.scriptLoader.isDebuggable()&&(superDump.debug=this.debugDump),superDump},Missile}(Shot_1.default);exports.default=Missile},{"./Configs":4,"./Consts":5,"./MissileCommand":13,"./MissileController":14,"./Shot":15}],13:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Command_1=require("./Command"),Configs_1=require("./Configs"),V_1=require("./V"),MissileCommand=function(_super){function MissileCommand(missile){var _this=_super.call(this)||this;return _this.missile=missile,_this.reset(),_this}return __extends(MissileCommand,_super),MissileCommand.prototype.reset=function(){this.speedUp=0,this.speedDown=0,this.turn=0},MissileCommand.prototype.execute=function(){if(0<this.missile.fuel){this.missile.direction+=this.turn;var normalized=V_1.default.direction(this.missile.direction);this.missile.speed=this.missile.speed.add(normalized.multiply(this.speedUp)),this.missile.speed=this.missile.speed.multiply(1-this.speedDown),this.missile.fuel-=(this.speedUp+3*this.speedDown)*Configs_1.default.FUEL_COST,this.missile.fuel=Math.max(0,this.missile.fuel)}},MissileCommand}(Command_1.default);exports.default=MissileCommand},{"./Command":3,"./Configs":4,"./V":20}],14:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Controller_1=require("./Controller"),Utils_1=require("./Utils"),MissileController=function(_super){function MissileController(missile){var _this=_super.call(this,missile)||this;_this.direction=function(){return missile.direction};missile.field;var command=missile.command;_this.fuel=function(){return missile.fuel},_this.scanEnemy=function(direction,angle,renge){command.validate(),missile.wait+=1.5;var missileDirection=missile.opposite(direction),radar=Utils_1.default.createRadar(missile.position,missileDirection,angle,renge||Number.MAX_VALUE);return missile.field.scanEnemy(missile.owner,radar)},_this.speedUp=function(){command.validate(),command.speedUp=.8},_this.speedDown=function(){command.validate(),command.speedDown=.1},_this.turnRight=function(){command.validate(),command.turn=-9},_this.turnLeft=function(){command.validate(),command.turn=9};return _this.log=function(){for(var message=[],_i=0;_i<arguments.length;_i++)message[_i]=arguments[_i];command.validate(),missile.log(message.map(function(value){return function(value){return"[object String]"===Object.prototype.toString.call(value)}(value)?value:JSON.stringify(value)}).join(", "))},_this.scanDebug=function(direction,angle,renge){command.validate(),missile.scanDebug(missile.opposite(direction),angle,renge)},_this}return __extends(MissileController,_super),MissileController.prototype.connectConsole=function(console){console&&(console.log=this.log.bind(this))},MissileController}(Controller_1.default);exports.default=MissileController},{"./Controller":6,"./Utils":19}],15:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Actor_1=require("./Actor"),Fx_1=require("./Fx"),V_1=require("./V"),Utils_1=require("./Utils"),Shot=function(_super){function Shot(field,owner,type){var _this=_super.call(this,field,owner.position.x,owner.position.y)||this;return _this.owner=owner,_this.type=type,_this.temperature=0,_this.damage=function(){return 0},_this.breakable=!1,_this}return __extends(Shot,_super),Shot.prototype.action=function(){this.onAction();var collided=this.field.checkCollision(this);collided&&(collided.onHit(this),this.createFxs()),this.field.checkCollisionEnviroment(this)&&(this.field.removeShot(this),this.createFxs())},Shot.prototype.createFxs=function(){for(var i=0;i<3;i++){var position=this.position.add(Utils_1.default.rand(16)-8,Utils_1.default.rand(16)-8),speed=new V_1.default(Utils_1.default.rand(1)-.5,Utils_1.default.rand(1)-.5),length_1=Utils_1.default.rand(8)+4;this.field.addFx(new Fx_1.default(this.field,position,this.speed.divide(2).add(speed),length_1))}},Shot.prototype.reaction=function(sourcer){sourcer.temperature+=this.temperature},Shot.prototype.onAction=function(){},Shot.prototype.dump=function(){return{o:this.owner.id,i:this.id,p:this.position.minimize(),d:this.direction,s:this.type}},Shot}(Actor_1.default);exports.default=Shot},{"./Actor":2,"./Fx":10,"./Utils":19,"./V":20}],16:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Actor_1=require("./Actor"),SourcerCommand_1=require("./SourcerCommand"),SourcerController_1=require("./SourcerController"),Configs_1=require("./Configs"),Consts_1=require("./Consts"),Utils_1=require("./Utils"),V_1=require("./V"),Laser_1=require("./Laser"),Missile_1=require("./Missile"),Fx_1=require("./Fx"),Sourcer=function(_super){function Sourcer(field,x,y,aiSource,account,name,color){var _this=_super.call(this,field,x,y)||this;return _this.aiSource=aiSource,_this.account=account,_this.name=name,_this.color=color,_this.alive=!0,_this.temperature=0,_this.shield=Configs_1.default.INITIAL_SHIELD,_this.missileAmmo=Configs_1.default.INITIAL_MISSILE_AMMO,_this.fuel=Configs_1.default.INITIAL_FUEL,_this.bot=null,_this.direction=Math.random()<.5?Consts_1.default.DIRECTION_RIGHT:Consts_1.default.DIRECTION_LEFT,_this.command=new SourcerCommand_1.default(_this),_this.controller=new SourcerController_1.default(_this),_this}return __extends(Sourcer,_super),Sourcer.prototype.compile=function(scriptLoader){if(this.scriptLoader=scriptLoader,this.bot=scriptLoader.load(this.aiSource),!this.bot)throw{message:"Function has not been returned."};if("function"!=typeof this.bot)throw{message:"Returned is not a Function."}},Sourcer.prototype.onThink=function(){if(null!==this.bot&&this.alive)try{this.command.accept(),this.controller.preThink(),this.debugDump={logs:[],arcs:[]},this.controller.connectConsole(this.scriptLoader.getExposedConsole()),this.bot(this.controller)}catch(error){this.debugDump.logs.push({message:"Sourcer function error: "+error.message,color:"red"}),this.command.reset()}finally{this.command.unaccept()}},Sourcer.prototype.action=function(){if(!this.alive&&Utils_1.default.rand(8)<1){var position=this.position.add(Utils_1.default.rand(16)-8,Utils_1.default.rand(16)-8),speed=new V_1.default(Utils_1.default.rand(1)-.5,Utils_1.default.rand(1)+.5),length_1=Utils_1.default.rand(8)+4;this.field.addFx(new Fx_1.default(this.field,position,speed,length_1))}if(this.speed=this.speed.multiply(Configs_1.default.SPEED_RESISTANCE),this.speed=this.speed.subtract(0,Configs_1.default.GRAVITY),Configs_1.default.TOP_INVISIBLE_HAND<this.position.y){var invisiblePower=.1*(this.position.y-Configs_1.default.TOP_INVISIBLE_HAND);this.speed=this.speed.subtract(0,Configs_1.default.GRAVITY*invisiblePower)}var diff=this.field.center-this.position.x;if(Configs_1.default.DISTANCE_BORDAR<Math.abs(diff)){var n=diff<0?-1:1,invisibleHand=(Math.abs(diff)-Configs_1.default.DISTANCE_BORDAR)*Configs_1.default.DISTANCE_INVISIBLE_HAND*n;this.position=new V_1.default(this.position.x+invisibleHand,this.position.y)}this.position.y<0&&(this.shield-=-this.speed.y*Configs_1.default.GROUND_DAMAGE_SCALE,this.position=new V_1.default(this.position.x,0),this.speed=new V_1.default(this.speed.x,0)),this.temperature-=Configs_1.default.COOL_DOWN,this.temperature=Math.max(this.temperature,0);var overheat=this.temperature-Configs_1.default.OVERHEAT_BORDER;if(0<overheat){var linearDamage=overheat*Configs_1.default.OVERHEAT_DAMAGE_LINEAR_WEIGHT,powerDamage=Math.pow(overheat*Configs_1.default.OVERHEAT_DAMAGE_POWER_WEIGHT,2);this.shield-=linearDamage+powerDamage}this.shield=Math.max(0,this.shield),this.command.execute(),this.command.reset()},Sourcer.prototype.fire=function(param){if("Laser"===param.shotType){var direction=this.opposite(param.direction),shot=new Laser_1.default(this.field,this,direction,param.power);shot.reaction(this),this.field.addShot(shot)}if("Missile"===param.shotType&&0<this.missileAmmo){var missile=new Missile_1.default(this.field,this,param.bot);missile.reaction(this),this.missileAmmo--,this.field.addShot(missile)}},Sourcer.prototype.opposite=function(direction){return this.direction===Consts_1.default.DIRECTION_LEFT?Utils_1.default.toOpposite(direction):direction},Sourcer.prototype.onHit=function(shot){this.speed=this.speed.add(shot.speed.multiply(Configs_1.default.ON_HIT_SPEED_GIVEN_RATE)),this.shield-=shot.damage(),this.shield=Math.max(0,this.shield),this.field.removeShot(shot)},Sourcer.prototype.log=function(message){this.debugDump.logs.push({message:message})},Sourcer.prototype.scanDebug=function(direction,angle,renge){this.debugDump.arcs.push({direction:direction,angle:angle,renge:renge})},Sourcer.prototype.dump=function(){var dump={i:this.id,p:this.position.minimize(),d:this.direction,h:Math.ceil(this.shield),t:Math.ceil(this.temperature),a:this.missileAmmo,f:Math.ceil(this.fuel)};return this.scriptLoader.isDebuggable()&&(dump.debug=this.debugDump),dump},Sourcer}(Actor_1.default);exports.default=Sourcer},{"./Actor":2,"./Configs":4,"./Consts":5,"./Fx":10,"./Laser":11,"./Missile":12,"./SourcerCommand":17,"./SourcerController":18,"./Utils":19,"./V":20}],17:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Command_1=require("./Command"),Configs_1=require("./Configs"),SourcerCommand=function(_super){function SourcerCommand(sourcer){var _this=_super.call(this)||this;return _this.sourcer=sourcer,_this.reset(),_this}return __extends(SourcerCommand,_super),SourcerCommand.prototype.reset=function(){this.ahead=0,this.ascent=0,this.turn=!1,this.fire=null},SourcerCommand.prototype.execute=function(){this.fire&&this.sourcer.fire(this.fire),this.turn&&(this.sourcer.direction*=-1),0<this.sourcer.fuel&&(this.sourcer.speed=this.sourcer.speed.add(this.ahead*this.sourcer.direction,this.ascent),this.sourcer.fuel-=(Math.abs(this.ahead)+Math.abs(this.ascent))*Configs_1.default.FUEL_COST,this.sourcer.fuel=Math.max(0,this.sourcer.fuel))},SourcerCommand}(Command_1.default);exports.default=SourcerCommand},{"./Command":3,"./Configs":4}],18:[function(require,module,exports){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Controller_1=require("./Controller"),Configs_1=require("./Configs"),Utils_1=require("./Utils"),FireParam_1=require("./FireParam"),SourcerController=function(_super){function SourcerController(sourcer){var _this=_super.call(this,sourcer)||this;_this.shield=function(){return sourcer.shield},_this.temperature=function(){return sourcer.temperature},_this.missileAmmo=function(){return sourcer.missileAmmo},_this.fuel=function(){return sourcer.fuel};var field=sourcer.field,command=sourcer.command;_this.scanEnemy=function(direction,angle,renge){command.validate(),sourcer.wait+=Configs_1.default.SCAN_WAIT;var oppositedDirection=sourcer.opposite(direction),normalizedRenge=renge||Number.MAX_VALUE,radar=Utils_1.default.createRadar(sourcer.position,oppositedDirection,angle,normalizedRenge);return field.scanEnemy(sourcer,radar)},_this.scanAttack=function(direction,angle,renge){command.validate(),sourcer.wait+=Configs_1.default.SCAN_WAIT;var oppositedDirection=sourcer.opposite(direction),normalizedRenge=renge||Number.MAX_VALUE,radar=Utils_1.default.createRadar(sourcer.position,oppositedDirection,angle,normalizedRenge);return field.scanAttack(sourcer,radar)},_this.ahead=function(){command.validate(),command.ahead=.8},_this.back=function(){command.validate(),command.ahead=-.4},_this.ascent=function(){command.validate(),command.ascent=.9},_this.descent=function(){command.validate(),command.ascent=-.9},_this.turn=function(){command.validate(),command.turn=!0},_this.fireLaser=function(direction,power){command.validate(),command.fire=FireParam_1.default.laser(power,direction)},_this.fireMissile=function(bot){command.validate(),command.fire=FireParam_1.default.missile(bot)};return _this.log=function(){for(var message=[],_i=0;_i<arguments.length;_i++)message[_i]=arguments[_i];command.validate(),sourcer.log(message.map(function(value){return function(value){return"[object String]"===Object.prototype.toString.call(value)}(value)?value:JSON.stringify(value)}).join(", "))},_this.scanDebug=function(direction,angle,renge){command.validate(),sourcer.scanDebug(sourcer.opposite(direction),angle,renge)},_this}return __extends(SourcerController,_super),SourcerController.prototype.connectConsole=function(console){console&&(console.log=this.log.bind(this))},SourcerController}(Controller_1.default);exports.default=SourcerController},{"./Configs":4,"./Controller":6,"./FireParam":9,"./Utils":19}],19:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var V_1=require("./V"),Utils=function(){function Utils(){}return Utils.createRadar=function(c,direction,angle,renge){var checkDistance=function(t){return c.distance(t)<=renge};if(360<=angle)return checkDistance;var checkLeft=Utils.side(c,direction+angle/2),checkRight=Utils.side(c,direction+180-angle/2);return angle<180?function(t){return checkLeft(t)&&checkRight(t)&&checkDistance(t)}:function(t){return(checkLeft(t)||checkRight(t))&&checkDistance(t)}},Utils.side=function(base,degree){var radian=Utils.toRadian(degree),direction=new V_1.default(Math.cos(radian),Math.sin(radian)),previously=base.x*direction.y-base.y*direction.x-1e-11;return function(target){return 0<=target.x*direction.y-target.y*direction.x-previously}},Utils.calcDistance=function(f,t,p){var toFrom=t.subtract(f),pFrom=p.subtract(f);if(toFrom.dot(pFrom)<1e-11)return pFrom.length();var fromTo=f.subtract(t),pTo=p.subtract(t);return fromTo.dot(pTo)<1e-11?pTo.length():Math.abs(toFrom.cross(pFrom)/toFrom.length())},Utils.toRadian=function(degree){return degree*(Math.PI/180)},Utils.toOpposite=function(degree){var normalized=Utils.normalizeDegree(degree);return normalized<=180?2*(90-normalized)+normalized:2*(270-normalized)+normalized},Utils.normalizeDegree=function(degree){var remainder=degree%360;return remainder<0?remainder+360:remainder},Utils.rand=function(renge){return Math.random()*renge},Utils}();exports.default=Utils},{"./V":20}],20:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var V=function(){function V(x,y){this.x=x,this.y=y}return V.prototype.add=function(v,y){return v instanceof V?new V(this.x+(v.x||0),this.y+(v.y||0)):new V(this.x+(v||0),this.y+(y||0))},V.prototype.subtract=function(v,y){return v instanceof V?new V(this.x-(v.x||0),this.y-(v.y||0)):new V(this.x-(v||0),this.y-(y||0))},V.prototype.multiply=function(v){return v instanceof V?new V(this.x*v.x,this.y*v.y):new V(this.x*v,this.y*v)},V.prototype.divide=function(v){return v instanceof V?new V(this.x/v.x,this.y/v.y):new V(this.x/v,this.y/v)},V.prototype.modulo=function(v){return v instanceof V?new V(this.x%v.x,this.y%v.y):new V(this.x%v,this.y%v)},V.prototype.negate=function(){return new V(-this.x,-this.y)},V.prototype.distance=function(v){return this.subtract(v).length()},V.prototype.length=function(){return this.calculatedLength?this.calculatedLength:(this.calculatedLength=Math.sqrt(this.dot()),this.calculatedLength)},V.prototype.normalize=function(){var current=this.length(),scale=0!==current?1/current:0;return this.multiply(scale)},V.prototype.angle=function(){return 180*this.angleInRadians()/Math.PI},V.prototype.angleInRadians=function(){return this.calculatedAngle?this.calculatedAngle:(this.calculatedAngle=Math.atan2(-this.y,this.x),this.calculatedAngle)},V.prototype.dot=function(point){return void 0===point&&(point=this),this.x*point.x+this.y*point.y},V.prototype.cross=function(point){return this.x*point.y-this.y*point.x},V.prototype.rotate=function(degree){var radian=degree*(Math.PI/180),cos=Math.cos(radian),sin=Math.sin(radian);return new V(cos*this.x-sin*this.y,cos*this.y+sin*this.x)},V.direction=function(degree){return new V(1,0).rotate(degree)},V.prototype.minimize=function(){return{x:Math.round(this.x),y:Math.round(this.y)}},V}();exports.default=V},{}]},{},[1]);
